<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Fraud Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tx-card { animation: slideIn 0.3s ease-out; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <header class="bg-gray-800 shadow-lg border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-400">‚ö° Real-Time Fraud Detection</h1>
                    <p class="text-gray-400 text-sm mt-1">Confluent Kafka + Flink + Google Gemini AI</p>
                </div>
                <div id="status" class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full pulse"></div>
                    <span class="text-sm">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Stats Cards -->
    <main class="max-w-7xl mx-auto px-6 py-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Total -->
            <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <div class="flex justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Transactions</p>
                        <p id="stat-total" class="text-3xl font-bold mt-2">0</p>
                    </div>
                    <div class="text-4xl">üìä</div>
                </div>
            </div>

            <!-- Fraud -->
            <div class="bg-gray-800 rounded-lg p-6 border border-red-500">
                <div class="flex justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Fraud Blocked</p>
                        <p id="stat-fraud" class="text-3xl font-bold mt-2 text-red-400">0</p>
                    </div>
                    <div class="text-4xl">üö®</div>
                </div>
            </div>

            <!-- Approved -->
            <div class="bg-gray-800 rounded-lg p-6 border border-green-500">
                <div class="flex justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Approved</p>
                        <p id="stat-approved" class="text-3xl font-bold mt-2 text-green-400">0</p>
                    </div>
                    <div class="text-4xl">‚úÖ</div>
                </div>
            </div>

            <!-- Review -->
            <div class="bg-gray-800 rounded-lg p-6 border border-yellow-500">
                <div class="flex justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Under Review</p>
                        <p id="stat-review" class="text-3xl font-bold mt-2 text-yellow-400">0</p>
                    </div>
                    <div class="text-4xl">‚ö†Ô∏è</div>
                </div>
            </div>
        </div>

        <!-- AI Model Stats -->
        <div class="bg-gray-800 rounded-lg p-6 border border-blue-500 mb-6">
            <h2 class="text-xl font-bold mb-4 text-center">ü§ñ Hybrid AI Detection System</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div>
                    <div class="text-4xl mb-2">ü§ñ</div>
                    <p class="text-gray-400 text-sm">Gemini AI</p>
                    <p id="stat-gemini" class="text-3xl font-bold mt-2 text-blue-400">0</p>
                    <p class="text-gray-500 text-xs mt-1">predictions</p>
                </div>
                <div>
                    <div class="text-4xl mb-2">üìã</div>
                    <p class="text-gray-400 text-sm">Rule-Based</p>
                    <p id="stat-rules" class="text-3xl font-bold mt-2 text-gray-400">0</p>
                    <p class="text-gray-500 text-xs mt-1">predictions</p>
                </div>
                <div>
                    <div class="text-4xl mb-2">‚ö°</div>
                    <p class="text-gray-400 text-sm">Avg Latency</p>
                    <p class="text-3xl font-bold mt-2 text-green-400">&lt;500ms</p>
                    <p class="text-gray-500 text-xs mt-1">end-to-end</p>
                </div>
            </div>
        </div>

        <!-- Fraud Rate Gauge -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
            <h2 class="text-xl font-bold mb-4">Fraud Rate</h2>
            <div class="flex items-center justify-center">
                <div class="relative">
                    <div class="text-6xl font-bold text-red-400" id="fraud-rate">0%</div>
                    <div class="text-center text-gray-400 mt-2">of transactions flagged</div>
                </div>
            </div>
        </div>

        <!-- Live Feed -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h2 class="text-xl font-bold mb-4">üî¥ Live Transaction Stream</h2>
            <div id="feed" class="space-y-2 max-h-96 overflow-y-auto">
                <div class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
                    <p class="text-gray-500">Waiting for live transactions...</p>
                    <p class="text-gray-600 text-xs mt-2">Make sure producer and consumer are running</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Tech Stack Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 mt-8 py-6">
        <div class="max-w-7xl mx-auto px-6">
            <h3 class="text-sm font-bold text-gray-400 mb-4 text-center">POWERED BY</h3>
            <div class="flex justify-center gap-8 flex-wrap">
                <div class="text-center">
                    <div class="text-3xl mb-1">‚òÅÔ∏è</div>
                    <div class="text-xs text-gray-400 font-semibold">Confluent Cloud</div>
                    <div class="text-xs text-gray-500">Kafka + Flink</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-1">ü§ñ</div>
                    <div class="text-xs text-gray-400 font-semibold">Google Cloud</div>
                    <div class="text-xs text-gray-500">Gemini 2.0 Flash</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-1">‚ö°</div>
                    <div class="text-xs text-gray-400 font-semibold">FastAPI</div>
                    <div class="text-xs text-gray-500">WebSocket</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-1">üé®</div>
                    <div class="text-xs text-gray-400 font-semibold">TailwindCSS</div>
                    <div class="text-xs text-gray-500">Responsive UI</div>
                </div>
            </div>
            <p class="text-center text-xs text-gray-500 mt-6">
                Real-Time Fraud Detection System | Confluent Challenge Submission | Built for AI Partner Catalyst Hackathon
            </p>
        </div>
    </footer>

    <script>
        const API_URL = 'http://localhost:8000';
        const WS_URL = 'ws://localhost:8000/ws/transactions';
        
        let ws;
        let reconnectAttempts = 0;

        // Update stats display
        function updateStats(data) {
            document.getElementById('stat-total').textContent = data.total.toLocaleString();
            document.getElementById('stat-fraud').textContent = data.fraud.toLocaleString();
            document.getElementById('stat-approved').textContent = data.approved.toLocaleString();
            document.getElementById('stat-review').textContent = data.review.toLocaleString();
            document.getElementById('fraud-rate').textContent = data.fraud_rate.toFixed(1) + '%';
            
            // Update AI model stats
            document.getElementById('stat-gemini').textContent = (data.gemini_predictions || 0).toLocaleString();
            document.getElementById('stat-rules').textContent = (data.rule_predictions || 0).toLocaleString();
        }

        // Add transaction to feed
        function addTransaction(txn) {
            const feed = document.getElementById('feed');
            
            // Remove placeholder
            if (feed.querySelector('.animate-spin')) {
                feed.innerHTML = '';
            }

            const decision = txn.decision || 'UNKNOWN';
            const amount = (txn.amount || 0).toLocaleString();
            const score = ((txn.fraud_score || 0) * 100).toFixed(0);
            const model = txn.model || 'unknown';

            let border = 'border-gray-700';
            let badge = '‚ö™ UNKNOWN';
            let badgeBg = 'bg-gray-600';

            if (decision === 'BLOCKED') {
                border = 'border-red-500';
                badge = 'üö® BLOCKED';
                badgeBg = 'bg-red-600';
            } else if (decision === 'APPROVED') {
                border = 'border-green-500';
                badge = '‚úÖ APPROVED';
                badgeBg = 'bg-green-600';
            } else if (decision === 'REVIEW') {
                border = 'border-yellow-500';
                badge = '‚ö†Ô∏è REVIEW';
                badgeBg = 'bg-yellow-600';
            }

            // Model badge
            const modelBadge = model === 'gemini-2.0-flash' ? 'ü§ñ Gemini AI' : 'üìã Rules';
            const modelBg = model === 'gemini-2.0-flash' ? 'bg-blue-600' : 'bg-gray-600';

            const card = document.createElement('div');
            card.className = `tx-card border ${border} rounded-lg p-4 bg-gray-750`;
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                            <span class="${badgeBg} text-xs px-2 py-1 rounded font-bold">${badge}</span>
                            <span class="${modelBg} text-xs px-2 py-1 rounded font-bold">${modelBadge}</span>
                            <span class="text-gray-400 text-xs">${txn.transaction_id || 'N/A'}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-400">User:</span>
                                <span class="ml-2">${txn.user_id || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Amount:</span>
                                <span class="ml-2 font-bold">‚Çπ${amount}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Risk Score:</span>
                                <span class="ml-2 font-bold ${score > 70 ? 'text-red-400' : score > 40 ? 'text-yellow-400' : 'text-green-400'}">
                                    ${score}%
                                </span>
                            </div>
                            <div>
                                <span class="text-gray-400">Velocity:</span>
                                <span class="ml-2">${txn.txn_count_1min || 0} txns/min</span>
                            </div>
                        </div>
                        ${txn.reasons ? `<div class="text-xs text-gray-400 mt-2">üí° ${txn.reasons}</div>` : ''}
                    </div>
                </div>
            `;

            feed.insertBefore(card, feed.firstChild);

            // Keep only last 20
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        // WebSocket connection
        function connect() {
            const status = document.getElementById('status');
            status.innerHTML = '<div class="w-3 h-3 bg-yellow-500 rounded-full pulse"></div><span class="text-sm">Connecting...</span>';

            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('‚úÖ Connected');
                status.innerHTML = '<div class="w-3 h-3 bg-green-500 rounded-full"></div><span class="text-sm">Connected</span>';
                reconnectAttempts = 0;
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'stats') {
                        updateStats(msg.data);
                    } else if (msg.type === 'transaction') {
                        addTransaction(msg.data);
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                status.innerHTML = '<div class="w-3 h-3 bg-red-500 rounded-full"></div><span class="text-sm">Error</span>';
            };

            ws.onclose = () => {
                console.log('‚ùå Disconnected');
                status.innerHTML = '<div class="w-3 h-3 bg-red-500 rounded-full"></div><span class="text-sm">Disconnected</span>';
                
                if (reconnectAttempts < 5) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                    console.log(`Reconnecting in ${delay/1000}s...`);
                    setTimeout(connect, delay);
                }
            };
        }

        // Fetch initial data
        async function loadInitialData() {
            try {
                const res = await fetch(`${API_URL}/api/stats`);
                const stats = await res.json();
                updateStats(stats);

                const txRes = await fetch(`${API_URL}/api/transactions/recent?limit=10`);
                const txData = await txRes.json();
                txData.transactions.forEach(addTransaction);
            } catch (e) {
                console.error('Failed to load initial data:', e);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Dashboard initializing...');
            loadInitialData();
            connect();
        });
    </script>
</body>
</html>